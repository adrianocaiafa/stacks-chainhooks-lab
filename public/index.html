<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chainhooks Manager</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
      text-align: center;
    }

    .header h1 {
      color: #333;
      margin-bottom: 10px;
    }

    .header p {
      color: #666;
    }

    .actions {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
    }

    .btn-danger {
      background: #e74c3c;
      color: white;
    }

    .btn-danger:hover {
      background: #c0392b;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .chainhooks-list {
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .chainhook-item {
      padding: 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s;
    }

    .chainhook-item:hover {
      background: #f8f9fa;
    }

    .chainhook-item:last-child {
      border-bottom: none;
    }

    .chainhook-info {
      flex: 1;
    }

    .chainhook-info h3 {
      color: #333;
      margin-bottom: 8px;
      font-size: 18px;
    }

    .chainhook-info p {
      color: #666;
      font-size: 14px;
      margin: 4px 0;
    }

    .chainhook-uuid {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: #999;
      background: #f0f0f0;
      padding: 4px 8px;
      border-radius: 4px;
      display: inline-block;
      margin-top: 8px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-state h2 {
      margin-bottom: 10px;
      color: #666;
    }

    .error {
      background: #fee;
      color: #c33;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      border-left: 4px solid #c33;
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 10px;
    }

    .badge-enabled {
      background: #d4edda;
      color: #155724;
    }

    .badge-disabled {
      background: #f8d7da;
      color: #721c24;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
          <h1>üîó Chainhooks Manager</h1>
          <p>Gerencie seus chainhooks da Stacks Blockchain</p>
          <p style="font-size: 12px; color: #999; margin-top: 10px;">Interface web para visualizar e gerenciar seus chainhooks</p>
        </div>
        <div id="wallet-section" style="text-align: right;">
          <div id="wallet-info" style="display: none; margin-bottom: 10px;">
            <p style="font-size: 12px; color: #666; margin: 4px 0;">
              <strong>Conectado:</strong> <span id="wallet-address" style="font-family: monospace; font-size: 11px;"></span>
            </p>
            <button class="btn" onclick="disconnectWallet()" style="background: #6c757d; color: white; padding: 5px 15px; font-size: 12px;">
              Desconectar
            </button>
          </div>
          <button id="connect-wallet-btn" class="btn btn-primary" onclick="connectWallet()">
            üîê Conectar Carteira
          </button>
        </div>
      </div>
    </div>

    <div id="error-container"></div>

    <div class="actions">
      <div>
        <button class="btn btn-primary" onclick="loadChainhooks()">üîÑ Atualizar Lista</button>
      </div>
      <div id="loading-indicator" style="display: none; color: #666;">
        Carregando...
      </div>
    </div>

    <div class="chainhooks-list" id="chainhooks-list">
      <div class="loading">Carregando chainhooks...</div>
    </div>
  </div>

  <script>
    // Estado da carteira
    let userData = null;
    let StacksConnectAPI = null;

    // Importa as bibliotecas Stacks de forma ass√≠ncrona
    (async () => {
      try {
        const { showConnect, showContractCall } = await import('https://cdn.jsdelivr.net/npm/@stacks/connect@7/+esm');
        const { StacksMainnet, StacksTestnet } = await import('https://cdn.jsdelivr.net/npm/@stacks/transactions@6/+esm');
        StacksConnectAPI = { showConnect, showContractCall, StacksMainnet, StacksTestnet };
        window.StacksConnectAPI = StacksConnectAPI;
        console.log('Stacks Connect carregado com sucesso');
      } catch (error) {
        console.error('Erro ao carregar bibliotecas Stacks:', error);
      }
    })();

    // Aguarda o DOM estar pronto
    document.addEventListener('DOMContentLoaded', () => {
      loadChainhooks();
    });

    // Conecta a carteira Stacks
    async function connectWallet() {
      try {
        if (!StacksConnectAPI || !StacksConnectAPI.showConnect) {
          alert('Biblioteca Stacks Connect ainda n√£o carregou. Aguarde alguns segundos e tente novamente.');
          return;
        }

        const { showConnect } = StacksConnectAPI;
        
        await showConnect({
          appDetails: {
            name: 'Chainhooks Lab',
            icon: window.location.origin + '/favicon.ico'
          },
          onFinish: (data) => {
            userData = data;
            // Extrai o endere√ßo do perfil
            if (data.profile && data.profile.stxAddress) {
              userData.address = data.profile.stxAddress.mainnet || data.profile.stxAddress.testnet;
            }
            updateWalletUI();
            loadChainhooks(); // Recarrega para atualizar bot√µes
          }
        });
      } catch (error) {
        console.error('Erro ao conectar carteira:', error);
        alert('Erro ao conectar carteira: ' + error.message);
      }
    }

    // Desconecta a carteira
    function disconnectWallet() {
      userData = null;
      updateWalletUI();
      loadChainhooks(); // Recarrega para atualizar bot√µes
    }

    // Atualiza a UI da carteira
    function updateWalletUI() {
      const walletInfo = document.getElementById('wallet-info');
      const walletAddress = document.getElementById('wallet-address');
      const connectBtn = document.getElementById('connect-wallet-btn');

      if (userData && userData.address) {
        walletInfo.style.display = 'block';
        connectBtn.style.display = 'none';
        const shortAddress = userData.address.length > 20 
          ? userData.address.substring(0, 10) + '...' + userData.address.substring(userData.address.length - 8)
          : userData.address;
        walletAddress.textContent = shortAddress;
      } else {
        walletInfo.style.display = 'none';
        connectBtn.style.display = 'block';
      }
    }

    // Chama uma fun√ß√£o do contrato
    async function callContractFunction(contractIdentifier, functionName, network) {
      if (!userData) {
        alert('Por favor, conecte sua carteira primeiro!');
        await connectWallet();
        return;
      }

      try {
        if (!StacksConnectAPI || !StacksConnectAPI.showContractCall) {
          alert('Biblioteca Stacks Connect ainda n√£o carregou. Aguarde alguns segundos e tente novamente.');
          return;
        }

        const { showContractCall, StacksMainnet, StacksTestnet } = StacksConnectAPI;
        
        const isMainnet = network === 'mainnet';
        const contractAddress = contractIdentifier.split('.')[0];
        const contractName = contractIdentifier.split('.')[1];
        
        // Para fun√ß√µes sem par√¢metros, usamos array vazio
        // Se a fun√ß√£o precisar de par√¢metros, eles devem ser adicionados aqui
        const functionArgs = [];
        
        await showContractCall({
          contractAddress: contractAddress,
          contractName: contractName,
          functionName: functionName,
          functionArgs: functionArgs,
          network: isMainnet ? StacksMainnet : StacksTestnet,
          onFinish: (data) => {
            console.log('Transa√ß√£o enviada:', data);
            alert(`Transa√ß√£o enviada com sucesso!\nTX ID: ${data.txId || data}\n\nO chainhook ser√° ativado quando a transa√ß√£o for confirmada.`);
            loadChainhooks(); // Recarrega para atualizar contadores
          },
          onCancel: () => {
            console.log('Transa√ß√£o cancelada pelo usu√°rio');
          }
        });
      } catch (error) {
        console.error('Erro ao chamar fun√ß√£o do contrato:', error);
        alert('Erro ao chamar fun√ß√£o: ' + error.message);
      }
    }

    // Fun√ß√£o para recarregar chainhooks periodicamente (opcional)
    // setInterval(loadChainhooks, 30000); // Recarrega a cada 30 segundos

    async function loadChainhooks() {
      const listContainer = document.getElementById('chainhooks-list');
      const loadingIndicator = document.getElementById('loading-indicator');
      const errorContainer = document.getElementById('error-container');
      
      errorContainer.innerHTML = '';
      loadingIndicator.style.display = 'block';
      listContainer.innerHTML = '<div class="loading">Carregando chainhooks...</div>';

      try {
        const response = await fetch('/api/chainhooks');
        const result = await response.json();

        loadingIndicator.style.display = 'none';

        if (!result.success) {
          throw new Error(result.error || 'Erro ao carregar chainhooks');
        }

        const chainhooks = result.data || [];

        if (chainhooks.length === 0) {
          listContainer.innerHTML = `
            <div class="empty-state">
              <h2>Nenhum chainhook encontrado</h2>
              <p>Voc√™ ainda n√£o criou nenhum chainhook.</p>
            </div>
          `;
          return;
        }

        listContainer.innerHTML = chainhooks.map(chainhook => {
          const definition = chainhook.definition || {};
          const status = chainhook.status || {};
          const name = definition.name || 'Sem nome';
          const isEnabled = status.enabled !== false;
          const statusText = status.status || 'unknown';
          const occurrenceCount = status.occurrence_count || 0;
          const evaluatedBlocks = status.evaluated_block_count || 0;
          const events = definition.filters?.events || [];
          
          // Formata os eventos para exibi√ß√£o
          const eventsHtml = events.map(event => {
            const eventType = event.type || 'N/A';
            const contractId = event.contract_identifier || 'N/A';
            const functionName = event.function_name || 'N/A';
            
            return `
              <div style="margin-top: 8px; padding: 8px; background: #f5f5f5; border-radius: 4px;">
                <p style="margin: 4px 0;"><strong>Tipo:</strong> ${eventType}</p>
                <p style="margin: 4px 0;"><strong>Contrato:</strong> <code style="background: #e0e0e0; padding: 2px 6px; border-radius: 3px; font-size: 12px;">${contractId}</code></p>
                <p style="margin: 4px 0;"><strong>Fun√ß√£o:</strong> <code style="background: #e0e0e0; padding: 2px 6px; border-radius: 3px; font-size: 12px;">${functionName}</code></p>
              </div>
            `;
          }).join('');
          
          // Verifica se h√° eventos de contract_call para permitir chamar fun√ß√£o
          const contractCallEvents = events.filter(e => e.type === 'contract_call');
          const canCallFunction = contractCallEvents.length > 0;
          const firstContractCall = contractCallEvents[0];
          
          return `
          <div class="chainhook-item">
            <div class="chainhook-info">
              <h3>
                ${name}
                ${isEnabled ? '<span class="badge badge-enabled">Ativo</span>' : '<span class="badge badge-disabled">Inativo</span>'}
                <span class="badge" style="background: #e3f2fd; color: #1976d2; margin-left: 8px;">${statusText}</span>
              </h3>
              <p><strong>Rede:</strong> ${definition.network || 'N/A'}</p>
              <p><strong>Cadeia:</strong> ${definition.chain || 'N/A'}</p>
              ${events.length > 0 ? `
                <div style="margin-top: 12px;">
                  <p><strong>Eventos (${events.length}):</strong></p>
                  ${eventsHtml}
                </div>
              ` : ''}
              ${occurrenceCount > 0 ? `<p><strong>Ocorr√™ncias:</strong> ${occurrenceCount}</p>` : ''}
              ${evaluatedBlocks > 0 ? `<p><strong>Blocos avaliados:</strong> ${evaluatedBlocks.toLocaleString()}</p>` : ''}
              <div class="chainhook-uuid">UUID: ${chainhook.uuid}</div>
            </div>
            <div style="display: flex; flex-direction: column; gap: 8px;">
              ${canCallFunction && firstContractCall ? `
                <button class="btn" style="background: #28a745; color: white;" 
                  onclick="callContractFunction('${firstContractCall.contract_identifier}', '${firstContractCall.function_name}', '${definition.network || 'mainnet'}')">
                  ‚ö° Chamar ${firstContractCall.function_name}
                </button>
              ` : ''}
              <button class="btn btn-danger" onclick="deleteChainhook('${chainhook.uuid}', '${name}')">
                üóëÔ∏è Deletar
              </button>
            </div>
          </div>
        `;
        }).join('');

      } catch (error) {
        loadingIndicator.style.display = 'none';
        errorContainer.innerHTML = `
          <div class="error">
            <strong>Erro:</strong> ${error.message}
          </div>
        `;
        listContainer.innerHTML = '<div class="empty-state"><h2>Erro ao carregar chainhooks</h2></div>';
      }
    }

    async function deleteChainhook(uuid, name) {
      // Solicita confirma√ß√£o antes de deletar
      if (!confirm(`Tem certeza que deseja deletar o chainhook "${name}"?\n\nUUID: ${uuid}\n\nEsta a√ß√£o n√£o pode ser desfeita.`)) {
        return;
      }

      const errorContainer = document.getElementById('error-container');
      errorContainer.innerHTML = '';

      try {
        const response = await fetch(`/api/chainhooks/${uuid}`, {
          method: 'DELETE'
        });

        const result = await response.json();

        if (!result.success) {
          throw new Error(result.error || 'Erro ao deletar chainhook');
        }

        // Recarregar a lista
        loadChainhooks();

      } catch (error) {
        errorContainer.innerHTML = `
          <div class="error">
            <strong>Erro ao deletar:</strong> ${error.message}
          </div>
        `;
      }
    };
  </script>
</body>
</html>

